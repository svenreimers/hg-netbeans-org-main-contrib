/*
  * The contents of this file are subject to the terms of the Common Development
  * and Distribution License (the License). You may not use this file except in
  * compliance with the License.
  *
  * You can obtain a copy of the License at http://www.netbeans.org/cddl.html
  * or http://www.netbeans.org/cddl.txt.
  *
  * When distributing Covered Code, include this CDDL Header Notice in each file
  * and include the License file at http://www.netbeans.org/cddl.txt.
  * If applicable, add the following below the CDDL Header, with the fields
  * enclosed by brackets [] replaced by your own identifying information:
  * "Portions Copyrighted [year] [name of copyright owner]"
  *
  * The Original Software is NetBeans. The Initial Developer of the Original
  * Software is Sun Microsystems, Inc. Portions Copyright 1997-2006 Sun
  * Microsystems, Inc. All Rights Reserved.
  */

package org.netbeans.modules.portalpack.servers.core.impl.j2eeservers.tomcat;

import java.io.File;
import java.io.IOException;
import java.util.logging.Logger;
import javax.swing.JTextField;
import org.netbeans.api.java.platform.JavaPlatform;
import org.netbeans.api.java.platform.JavaPlatformManager;
import org.netbeans.api.java.platform.Specification;
import org.netbeans.modules.portalpack.servers.core.WizardPropertyReader;
import org.netbeans.modules.portalpack.servers.core.api.ConfigPanel;
import org.netbeans.modules.portalpack.servers.core.util.DirectoryChooser;
import org.netbeans.modules.portalpack.servers.core.util.NetbeanConstants;
import org.netbeans.modules.portalpack.servers.core.util.PSConfigObject;
import org.openide.WizardDescriptor;
import org.openide.filesystems.FileObject;
import org.openide.filesystems.FileUtil;
import org.xml.sax.SAXException;

/**
 *
 * @author  satya
 */
public class TomcatConfigPanel extends ConfigPanel implements TomcatConstant{
    
    private static Logger logger = Logger.getLogger(NetbeanConstants.PORTAL_LOGGER);
    /** Creates new form TomcatConfigPanel */
    public TomcatConfigPanel() {
        initComponents();
        initData();
        
    }
    
    private void initData() {
        setJavaPlatform();
    }
    
    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    // <editor-fold defaultstate="collapsed" desc=" Generated Code ">//GEN-BEGIN:initComponents
    private void initComponents() {
        jLabel1 = new javax.swing.JLabel();
        homeTf = new javax.swing.JTextField();
        homeButton = new javax.swing.JButton();
        jLabel2 = new javax.swing.JLabel();
        tomcatUserNameTf = new javax.swing.JTextField();
        jLabel3 = new javax.swing.JLabel();
        tomcatPasswordTf = new javax.swing.JPasswordField();
        jLabel4 = new javax.swing.JLabel();
        baseTf = new javax.swing.JTextField();
        baseButton = new javax.swing.JButton();
        jLabel5 = new javax.swing.JLabel();
        javacombo = new javax.swing.JComboBox();
        jLabel6 = new javax.swing.JLabel();
        portTf = new javax.swing.JTextField();
        jLabel7 = new javax.swing.JLabel();
        adminPortTf = new javax.swing.JTextField();

        jLabel1.setFont(new java.awt.Font("Tahoma", 1, 11));
        jLabel1.setText(org.openide.util.NbBundle.getMessage(TomcatConfigPanel.class, "LBL_CATALINA_HOME"));

        homeTf.addFocusListener(new java.awt.event.FocusAdapter() {
            public void focusLost(java.awt.event.FocusEvent evt) {
                homeTfFocusLost(evt);
            }
        });

        homeButton.setText("...");
        homeButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                homeButtonActionPerformed(evt);
            }
        });

        jLabel2.setFont(new java.awt.Font("Tahoma", 1, 11));
        jLabel2.setText(org.openide.util.NbBundle.getMessage(TomcatConfigPanel.class, "LBL_USER_NAME"));

        jLabel3.setFont(new java.awt.Font("Tahoma", 1, 11));
        jLabel3.setText(org.openide.util.NbBundle.getMessage(TomcatConfigPanel.class, "LBL_PASSWORD"));

        jLabel4.setFont(new java.awt.Font("Tahoma", 1, 11));
        jLabel4.setText(org.openide.util.NbBundle.getMessage(TomcatConfigPanel.class, "LBL_CATALINA_BASE"));

        baseTf.addFocusListener(new java.awt.event.FocusAdapter() {
            public void focusLost(java.awt.event.FocusEvent evt) {
                baseTfFocusLost(evt);
            }
        });

        baseButton.setText("...");
        baseButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                baseButtonActionPerformed(evt);
            }
        });

        jLabel5.setFont(new java.awt.Font("Tahoma", 1, 11));
        jLabel5.setText(org.openide.util.NbBundle.getMessage(TomcatConfigPanel.class, "LBL_JAVA_HOME"));

        jLabel6.setFont(new java.awt.Font("Tahoma", 1, 11));
        jLabel6.setText(org.openide.util.NbBundle.getMessage(TomcatConfigPanel.class, "LBL_PORT"));

        jLabel7.setFont(new java.awt.Font("Tahoma", 1, 11));
        jLabel7.setText(org.openide.util.NbBundle.getMessage(TomcatConfigPanel.class, "LBL_ADMIN_PORT"));

        org.jdesktop.layout.GroupLayout layout = new org.jdesktop.layout.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
            .add(layout.createSequentialGroup()
                .addContainerGap()
                .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
                    .add(jLabel1)
                    .add(jLabel4)
                    .add(jLabel5)
                    .add(jLabel2)
                    .add(jLabel6)
                    .add(jLabel7)
                    .add(jLabel3))
                .add(19, 19, 19)
                .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
                    .add(layout.createSequentialGroup()
                        .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.TRAILING, false)
                            .add(org.jdesktop.layout.GroupLayout.LEADING, javacombo, 0, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                            .add(org.jdesktop.layout.GroupLayout.LEADING, layout.createSequentialGroup()
                                .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.TRAILING, false)
                                    .add(org.jdesktop.layout.GroupLayout.LEADING, baseTf)
                                    .add(org.jdesktop.layout.GroupLayout.LEADING, homeTf, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 289, Short.MAX_VALUE))
                                .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)))
                        .addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED)
                        .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.TRAILING)
                            .add(homeButton, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 34, Short.MAX_VALUE)
                            .add(org.jdesktop.layout.GroupLayout.LEADING, baseButton, 0, 0, Short.MAX_VALUE)))
                    .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.TRAILING, false)
                        .add(org.jdesktop.layout.GroupLayout.LEADING, tomcatUserNameTf, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 98, Short.MAX_VALUE)
                        .add(org.jdesktop.layout.GroupLayout.LEADING, portTf)
                        .add(org.jdesktop.layout.GroupLayout.LEADING, adminPortTf)
                        .add(org.jdesktop.layout.GroupLayout.LEADING, tomcatPasswordTf)))
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
            .add(layout.createSequentialGroup()
                .addContainerGap()
                .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.BASELINE)
                    .add(jLabel1)
                    .add(homeTf, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)
                    .add(homeButton))
                .add(14, 14, 14)
                .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.BASELINE)
                    .add(jLabel4)
                    .add(baseButton)
                    .add(baseTf, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE))
                .add(17, 17, 17)
                .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.BASELINE)
                    .add(jLabel5)
                    .add(javacombo, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE))
                .add(15, 15, 15)
                .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.TRAILING)
                    .add(jLabel6)
                    .add(portTf, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE))
                .add(17, 17, 17)
                .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.BASELINE)
                    .add(jLabel7)
                    .add(adminPortTf, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE))
                .add(17, 17, 17)
                .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.TRAILING)
                    .add(jLabel2)
                    .add(tomcatUserNameTf, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 20, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE))
                .add(8, 8, 8)
                .add(layout.createParallelGroup(org.jdesktop.layout.GroupLayout.TRAILING)
                    .add(jLabel3)
                    .add(tomcatPasswordTf, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, org.jdesktop.layout.GroupLayout.PREFERRED_SIZE))
                .addContainerGap(org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );
    }// </editor-fold>//GEN-END:initComponents

    private void baseTfFocusLost(java.awt.event.FocusEvent evt) {//GEN-FIRST:event_baseTfFocusLost
// TODO add your handling code here:
        populateAllDefaultValues();
    }//GEN-LAST:event_baseTfFocusLost

    private void homeTfFocusLost(java.awt.event.FocusEvent evt) {//GEN-FIRST:event_homeTfFocusLost
// TODO add your handling code here:
        if(!checkIfValueAlreadySet(baseTf))
        {
            baseTf.setText(homeTf.getText());
        }
        populateAllDefaultValues();
    }//GEN-LAST:event_homeTfFocusLost
    
    private void baseButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_baseButtonActionPerformed
        
        DirectoryChooser chooser = new DirectoryChooser();
        chooser.open(System.getProperty("netbeans.user"));
        String dir = chooser.getSelectedDir();
        baseTf.setText(dir);
        populateAllDefaultValues();
    }//GEN-LAST:event_baseButtonActionPerformed
    
    private void homeButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_homeButtonActionPerformed
// TODO add your handling code here:
        
        DirectoryChooser chooser = new DirectoryChooser();
        chooser.open(System.getProperty("user.dir"));
        String dir = chooser.getSelectedDir();
        homeTf.setText(dir);
        if(!checkIfValueAlreadySet(baseTf))
        {
            baseTf.setText(dir);
        }
        populateAllDefaultValues();
    }//GEN-LAST:event_homeButtonActionPerformed
    
      /** Update the jvm model */
    private void loadJvmModel() {
       /* JavaPlatformManager jpm = JavaPlatformManager.getDefault();
        JavaPlatformAdapter curJvm = (JavaPlatformAdapter)jvmModel.getSelectedItem();
        String curPlatformName = null;
        if (curJvm != null) {
            curPlatformName = curJvm.getName();
        } else {
            curPlatformName = (String)tp.getJavaPlatform().getProperties().get(TomcatProperties.PLAT_PROP_ANT_NAME);
        }

        jvmModel.removeAllElements();
        
        // feed the combo with sorted platform list
        JavaPlatform[] j2sePlatforms = jpm.getPlatforms(null, new Specification("J2SE", null)); // NOI18N
        JavaPlatformAdapter[] platformAdapters = new JavaPlatformAdapter[j2sePlatforms.length];
        for (int i = 0; i < platformAdapters.length; i++) {
            platformAdapters[i] = new JavaPlatformAdapter(j2sePlatforms[i]);
        }
        Arrays.sort(platformAdapters);
        for (int i = 0; i < platformAdapters.length; i++) {
            JavaPlatformAdapter platformAdapter = platformAdapters[i];
            jvmModel.addElement(platformAdapter);
            // try to set selected item
            if (curPlatformName != null) {
                if (curPlatformName.equals(platformAdapter.getName())) {
                    jvmModel.setSelectedItem(platformAdapter);
                }
            }   
        }*/
    }
    private boolean checkIfValueAlreadySet(JTextField jt)
    {
        String value = jt.getText();
        if(value == null || value.trim().length() == 0)
            return false;
        else
            return true;
    }
    
    private void populateAllDefaultValues()
    {
        String catalinaHome = homeTf.getText();
        String catalinaBase = baseTf.getText();
        
        TomcatConfigUtil configUtil = null;
        try {
            configUtil = new TomcatConfigUtil(new File(catalinaBase));
        } catch (SAXException ex) {
            
            setErrorMessage("Not a valid server.xml");
            fireChangeEvent();
            clearDomainXmlData();
            return;
        } catch (IOException ex) {
            setErrorMessage("Not a valid catalina base directory");
            fireChangeEvent();
            clearDomainXmlData();
            return;
        }catch(Exception e){
            setErrorMessage("Not a valid catalina base dir");
            clearDomainXmlData();
            fireChangeEvent();
            return;
        }
         setErrorMessage("");
                    
        String port = configUtil.getHttpPort();
        portTf.setText(port);
        
        adminPortTf.setText(port);
        fireChangeEvent();
    }
    public void populateDataForCustomizer(PSConfigObject object) {
        
        homeTf.setText(object.getProperty(CATALINA_HOME));
        baseTf.setText(object.getProperty(CATALINA_BASE));
        tomcatUserNameTf.setText(object.getProperty(MANAGER_USER));
        tomcatPasswordTf.setText(object.getProperty(MANAGER_PASSWORD));
        
        String javaHome = object.getProperty(JAVA_HOME);
        JavaHome javaHomeObject = findJavaHomeObject(javaHome);
        if(javaHomeObject != null)
        {
            javacombo.setSelectedItem(javaHomeObject);
            javacombo.setEnabled(false);
        }
        else{
           
             setJavaPlatform();
        }
        
        portTf.setText(object.getPort());
        adminPortTf.setText(object.getAdminPort());
    }
    
    public void read(WizardDescriptor wizardDescriptor) {
        //wd = wizardDescriptor;
        logger.info("Inside read of TomcatConfigPanel...................");
                
    }
    
    public void store(WizardDescriptor d) {
        
        WizardPropertyReader wr = new WizardPropertyReader(d);
        wr.setProperty(CATALINA_HOME,homeTf.getText());
        wr.setProperty(MANAGER_USER,tomcatUserNameTf.getText());
        wr.setProperty(MANAGER_PASSWORD,new String(tomcatPasswordTf.getPassword()));
        wr.setProperty(CATALINA_BASE,baseTf.getText());
        
        
        JavaHome javaHome = (JavaHome)javacombo.getSelectedItem();
        wr.setProperty(JAVA_HOME,javaHome.getJavaHome());
        wr.setPort(portTf.getText());
        wr.setAdminPort(adminPortTf.getText());
    }
    
    public boolean validate(Object wizardDescriptor) {
       String catalinaHome = homeTf.getText();
        String catalinaBase = baseTf.getText();
        
        TomcatConfigUtil configUtil = null;
        try {
            configUtil = new TomcatConfigUtil(new File(catalinaBase));
        } catch (SAXException ex) {
            
            setErrorMessage("Not a valid server.xml");
            
            clearDomainXmlData();
            return false;
        } catch (IOException ex) {
            
            setErrorMessage("Not a valid catalina base directory");
            
            clearDomainXmlData();
            return false;
        }catch(Exception e){
            
            setErrorMessage("Not a valid catalina base dir");
            clearDomainXmlData();
            return false;
        }
         
        setErrorMessage("");
                 
        return true;
    }
    
    private void clearDomainXmlData()
    {
        portTf.setText("");
        adminPortTf.setText("");
    }
    
    public String getDescription() {
        return "Tomcat";
    }
    
    public void setJavaPlatform() {
        
        JavaPlatformManager jpm = JavaPlatformManager.getDefault();
        JavaPlatform[] installedPlatforms = jpm.getPlatforms(null, new Specification("J2SE", null)); // NOI18N
        
        JavaPlatform defaultPlatform  = jpm.getDefaultPlatform();
        JavaHome javaHomeObj = new JavaHome(defaultPlatform.getDisplayName(),getJavaHome(defaultPlatform));
        String javaHome = javaHomeObj.getJavaHome();
        javacombo.addItem(javaHomeObj);
        
        for (int i = 0; i < installedPlatforms.length; i++) {
            String sjavaHome = getJavaHome(installedPlatforms[i]);
            if(sjavaHome == null)
                continue;
            
            if(!sjavaHome.equals(javaHome)) {
                JavaHome pjavaHome = new JavaHome(installedPlatforms[i].getDisplayName(),sjavaHome);
                javacombo.addItem(pjavaHome);
            }
        }
        
    }
    
    public JavaHome findJavaHomeObject(String javaHome) {
        JavaPlatformManager jpm = JavaPlatformManager.getDefault();
        JavaPlatform[] installedPlatforms = jpm.getPlatforms(null, new Specification("J2SE", null)); // NOI18N
        
        for (int i = 0; i < installedPlatforms.length; i++) {
            
            String sjavaHome = getJavaHome(installedPlatforms[i]);
            
            if(sjavaHome == null)
                continue;
            
            if(sjavaHome.equalsIgnoreCase(javaHome))
                return new JavaHome(installedPlatforms[i].getDisplayName(),getJavaHome(installedPlatforms[i]));
            
        }
        
        return null;
        
    }
    
    
    
    private String getJavaHome(JavaPlatform platform) {
        try{
            FileObject fo = (FileObject)platform.getInstallFolders().iterator().next();
            return FileUtil.toFile(fo).getAbsolutePath();
        }catch(Exception e){
            return null;
        }
    }
    
   
    
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JTextField adminPortTf;
    private javax.swing.JButton baseButton;
    private javax.swing.JTextField baseTf;
    private javax.swing.JButton homeButton;
    private javax.swing.JTextField homeTf;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JLabel jLabel5;
    private javax.swing.JLabel jLabel6;
    private javax.swing.JLabel jLabel7;
    private javax.swing.JComboBox javacombo;
    private javax.swing.JTextField portTf;
    private javax.swing.JPasswordField tomcatPasswordTf;
    private javax.swing.JTextField tomcatUserNameTf;
    // End of variables declaration//GEN-END:variables
    
    class JavaHome{
        public String displayName;
        public String javaHome;
        public JavaHome(String displayName,String javaHome) {
            this.displayName = displayName;
            this.javaHome = javaHome;
        }
        
        public String toString() {
            return displayName + "(" + javaHome + ")";
        }
        
        public String getJavaHome() {
            return javaHome;
        }
        
    }
    
    
     private static class JavaPlatformAdapter implements Comparable {
        private JavaPlatform platform;
        
        public JavaPlatformAdapter(JavaPlatform platform) {
            this.platform = platform;
        }
        
        public JavaPlatform getJavaPlatform() {
            return platform;
        }
        
        public String getName() {
            return "name";
        }
        
        public String toString() {
            return platform.getDisplayName();
        }
        
        public int compareTo(Object o) {
            return toString().compareTo(o.toString());
        }
     }
}
